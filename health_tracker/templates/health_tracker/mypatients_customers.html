{% extends "health_tracker/layout.html" %}
{% load static %}
{% block title %}My Patients/Customers{% endblock %}
{% block styling %}<link href = "{% static 'health_tracker/scss/search.css' %}" rel="stylesheet">{% endblock %}
{% block body %}
{% if patients_customers %}
    <h1 class="title">Patients/Customers</h1>
    <div class="patient-container">
        {% for person in patients_customers %}
            <div class="patient-container__patient-div">
                {% if user_type == 'nou' %}
                <!-- {% if person %} -->
                    <a href="{% url 'other_profile' person.account.username %}" class="patient-container__patient-link">
                        <p>{{person.full_com_name}} ({{person.account.username}})</p>  
                        <!-- {% if user in person.hcw_v.all %}
                            <button type="button" class="delete_patient" data-pos="{{forloop.counter}}">
                                <img src="{% static 'health_tracker/delete.svg' %}" />
                            </button>
                        {% endif %} -->
                    </a>
                <!-- {% endif %} -->
                {% else %}
                    <a href="{% url 'other_profile' person.person.username %}" class="patient-container__patient-link">
                        <p>{{person.full_name}} ({{person.person.username}})</p>  
                        <!-- {% if user in person.hcw_v.all %}
                            <button type="button" class="delete_patient" data-pos="{{forloop.counter}}">
                                <img src="{% static 'health_tracker/delete.svg' %}" />
                            </button>
                        {% endif %} -->
                        </a>
                {% endif %}
                <!-- {% if user in person.hcw_v.all %}
                <div class="delete_patient_modal" tabindex="-1" data-pos="{{forloop.counter}}" aria-labelledby="ModalLabel" aria-hidden="true">
                    <div class="modal_dialog">
                        <div class="modal_content">
                            <div class="modal_header">
                            <h5 class="modal_title">{% if user_type == 'nou' %} Remove Doctor/Vendor {% else %} Remove Patient/Customer {% endif %}</h5>
                            </div>
                            <div class="modal-body">
                            <p>Are you sure you want to remove {% if user_type == 'nou' %} doctor/vendor {% else %} patient/customer {% endif %}</p>
                            {% if user_type == 'nou' %}
                                <p class="modal-patientname" data-id="{{person.account.username}}">"{{person.full_com_name}} ({{person.account.username}})"</p>
                            {% else %}
                                <p class="modal-patientname" data-id="{{person.person.username}}">"{{person.full_name}} ({{person.person.username}})"</p>
                            {% endif %}
                            </div>
                            <div class="modal_footer">
                            <button type="button" class="delete_patient_cancel" data-pos="{{forloop.counter}}">Cancel</button>
                            <button type="button" class="delete_patient_main" data-person="{{person}}" id="remove_person{{person}}">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %} -->
            </div>
        {% endfor %}
    </div>
{% endif %}

{% endblock %}

<!-- {% block script %}
<script>
    let delete_patient_btn = document.querySelectorAll('.delete_patient');
    delete_patient_btn.forEach(button => {
       button.addEventListener('click', (e) => {
          e.preventDefault();
          let elearray = [...document.querySelectorAll('.delete_patient_modal')];
          // console.log(elearray);
          for(let i = 0; i < elearray.length; i++){
             if(elearray[i].dataset.pos == button.dataset.pos){
                elearray[i].style.display = 'block';
             }
          }
       });
    });

    let cancel_patient_btn = document.querySelectorAll('.delete_patient_cancel');
    cancel_patient_btn.forEach(button => {
       button.addEventListener('click', (e) => {
          e.preventDefault();
          let elearray = [...document.querySelectorAll('.delete_patient_modal')];
          // console.log(elearray);
          for(let i = 0; i < elearray.length; i++){
             if(elearray[i].dataset.pos == button.dataset.pos){
                elearray[i].style.display = 'none';
             }
          }
       });
    });

    // TODO Amog change code here to delete patient
    let delete_patient_class = document.querySelectorAll('.delete_patient_main')
    delete_patient_class.forEach(button => {button.addEventListener('click',event => {
       let id=event.target.id.split('remove_person')[1]
       let patient=button.getAttribute("data-person")
       let to_delete="yes"

       DeletePatient(id,patient,to_delete)
       // console.log(document.querySelector('input[name="csrfmiddlewaretoken"]').value)
    })})

    function DeletePatient(id,patient,to_delete) {
       fetch(`/remove/${patient}`,{
          method:"POST",
          headers:{'X-CSRFToken':document.querySelector('input[name="csrfmiddlewaretoken"]').value }, //csrf token getAttribute('content')
          body:JSON.stringify({
             to_delete:to_delete // who is the logged in dude?
          })
       })
       .then(response => response.json())
       .then(data => {
          if (data.status===200) {
             location.reload()
          }
       })
    }
</script>
{% endblock %} -->