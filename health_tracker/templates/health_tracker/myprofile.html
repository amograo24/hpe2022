{% extends "health_tracker/layout.html" %}
{% load static %}
{% block title %}Home{% endblock %}
{% block styling %}
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>   
    <link href="{% static 'health_tracker/scss/dashboard.css' %}" rel="stylesheet"> 
{% endblock %}
{% block body %}
    <main class="dashboard">
    <div>
        <div>
            <h1 class="title">Patient Details</h1>
        </div>
    </div> 
    {% if nou %}
        <div class="dashboard__patient">
            <div class="dashboard__patient-personal">
                <h3>Full Name: {{user.full_name}}</h3>
                <h3>Email: {{user.person.email}}</h3>
                <h3>Well-Being ID: {{user.person.username}}</h3>
                <h3>Aadhar ID: {{user.aadharid}}</h3>
                <div  id="qrcode-generated">
                    {% csrf_token %}
                    <!--    this tag will generate the qrcode, the qrcode will be sent from the backend after it's generation-->
                        <img src="" alt="Invalid Image" id="qr-image" width="200px">
                    <script>

                        function set_image(blobResponse)
                        {
                            const imageObjectURL = URL.createObjectURL(blobResponse)
                            document.getElementById("qr-image").src = imageObjectURL;
                        }

                        function get_qr()
                        {
                        let token = $("input[name='csrfmiddlewaretoken']").val()
                        let url = "/getQr"
                        let header = {'X-CSRFToken': token}
                        let request = fetch(url, {method: "POST", headers: header, body: JSON.stringify({uid: "/visit/{{ user.wbid }}"})})
                        request.then(resp => resp.blob())
                        .then(set_image)
                        }
                        $(document).ready(get_qr)
                    </script>
                </div>
            </div>
            <hr/>
            <div class="dashboard__health-stat">
                <h1 class="heading">Health Status</h1>
                <hr/>
                {% for health_value in health_status.health_status.all %}
                    <div class="dashboard__health-item">
                        <h4>
                            {{health_value.health_condition}}
                        </h4>
                        <div class="container">
                            <div 
                                id="slider{{ forloop.counter }}" 
                                class="slider" 
                                data-pos="{{ forloop.counter }}"
                                style="
                                        display: flex; 
                                        height: 25px;
                                        width: 80vw;
                                        margin: 0 auto;
                                        border: 1px solid #FFC107;
                                ">
                                <div id="custom-handle{{ forloop.counter }}" class="ui-slider-handle" style="
                                width: 3em;
                                height: 40px;
                                top: 50%;
                                text-align: center;
                                line-height: 40px;
                                margin-top: -20px;
                                z-index: 0;
                                background-color: #FFC107;
                                color: #141A26;
                                border: 1px solid #FFC107;"></div>
                                <div class="bg1" id="bg1{{forloop.counter}}""></div>
                                <div class="bg2" id="bg2{{forloop.counter}}"></div>
                                <div class="bg3" id="bg3{{forloop.counter}}"></div>
                            </div>
                        </div>
                        <div class="dashboard__labels container">
                            {% if health_value.minimum_value != None %}
                                <label id="mini{{forloop.counter}}">{{health_value.minimum_value}}</label>
                            {% else %}
                                <label hidden id="mini{{forloop.counter}}">{{health_value.minimum_value}}</label>
                            {% endif %}
                            {% if health_value.maximum_value != None %}
                                <label id="maxi{{forloop.counter}}">{{health_value.maximum_value}}</label>
                            {% else %}
                                <label hidden id="maxi{{forloop.counter}}">{{health_value.maximum_value}}</label>
                            {% endif %}
                        </div>
                        <label hidden id="patient{{forloop.counter}}">{{health_value.patient_value}}</label>
                        {% if health_value.condition_category == "SAFE" %}
                            <h5 class="safe dashboard__category">
                                CONDITION: {{health_value.condition_category}}
                            </h5>
                        {% endif %}
                        {% if health_value.condition_category == "WARNING" %}
                            <h5 class="warning dashboard__category">
                                CONDITION: {{health_value.condition_category}}
                            </h5>
                        {% endif %}
                        {% if health_value.condition_category == "DANGER" %}
                            <h5 class="danger dashboard__category">
                                CONDITION: {{health_value.condition_category}}
                            </h5>
                        {% endif %}
                        {% if health_value.condition_category == "BDL-SAFE" %}
                            <h5 class="bdl-safe dashboard__category">
                                CONDITION: {{health_value.condition_category}}
                            </h5>
                        {% endif %}
                        {% if health_value.condition_category == "BDL-DANGER" %}
                        <h5 class="bdl-danger dashboard__category">
                            CONDITION: {{health_value.condition_category}}
                        </h5>
                    {% endif %}
                    </div>
                    <hr/>
                {% endfor %}
            </div>
        </div>
    {% elif non_nou %}
        <h3>
            {% if user.account.division.lower == 'd/hcw/ms' %} 
                Full Name: 
            {% else %} 
                Company Name: 
            {% endif %} 
                {{user.full_com_name}}
        </h3>
        <h3>
            Email: {{user.account.email}}
        </h3>
        <h3>
            Health Care Worker/Vendor ID: {{user.account.username}}
        </h3>
        <h3>Registration No./License No.: {{user.reg_no}}</h3>
        {% if user.account.division.lower == 'd/hcw/ms' %}
            <h3>
                Department: {{user.department}}
            </h3>
        {% endif %}
        <h3>
            Account Visibility: 
            {% if user.public %}
                Public
            {% else %}
                Private
            {% endif %}
        </h3>
        {% if user.public == True %}
            <button onclick="window.location.href='/goprivate'" >Go Private</button>
        {% else %}
            <button onclick="window.location.href='/gopublic'">Go Public</button>
        {% endif %}
    {% endif %}
{% endblock %}
{% block script %}
<script>
    $(function() {
        let sliders = document.querySelectorAll(".slider");
        for(let id = 1; id <= sliders.length; id++){
            let mini = $(`#mini${id}`).html()
            let maxi = $(`#maxi${id}`).html()
            let patient = $(`#patient${id}`).html()
            patient = parseFloat(patient)
            let leftLimit, rightLimit;
            if(mini == "None" && maxi == "None"){
                mini = patient-(patient/2);
                maxi = patient+(patient/2);
                $(`#bg1${id}`).width(0)
                $(`#bg2${id}`).width(`100%`)
                $(`#bg2${id}`).css('background-color', '#1760BF')
                $(`#bg3${id}`).width(0)
            }
            mini = parseFloat(mini)
            maxi = parseFloat(maxi)
            if(patient <= mini){
                leftLimit = patient;
                rightLimit = maxi;
                let maxDiff = (maxi - patient);
                let nonIdeal = ((mini-patient)/maxDiff)*100;
                let ideal = ((maxi - mini)/maxDiff)*100;
                $(`#bg1${id}`).width(`${nonIdeal}%`)
                $(`#bg2${id}`).width(`${ideal}%`)
                $(`#bg3${id}`).width(0)
            }
            if(patient >= maxi){
                leftLimit = mini;
                rightLimit = patient;
                let maxDiff = (patient - mini);
                let nonIdeal = ((patient - maxi)/maxDiff)*100;
                let ideal = ((maxi - mini)/maxDiff)*100;
                $(`#bg1${id}`).width(0)
                $(`#bg2${id}`).width(`${ideal}%`)
                $(`#bg3${id}`).width(`${nonIdeal}%`)
            }
            if(mini < patient && patient < maxi){
                leftLimit = mini;
                rightLimit = maxi;
                let maxDiff = (maxi - mini);
                let ideal = ((maxi - mini)/maxDiff)*100;
                $(`#bg1${id}`).width(0)
                $(`#bg2${id}`).width(`${ideal}%`)
                $(`#bg3${id}`).width(0)
            }
            $(`#mini${id}`).html(leftLimit)
            $(`#maxi${id}`).html(rightLimit)
            var handle = $(`#custom-handle${id}`);
            $(`#slider${id}` ).slider({
                value: patient,
                min:leftLimit,
                max: rightLimit,
                create: function() {
                    handle.text( $(this).slider( "value" ) );
                },
            });
        }
    });
</script>
{% endblock script %}