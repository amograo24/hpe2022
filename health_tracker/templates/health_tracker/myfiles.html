{% extends "health_tracker/layout.html" %}
{% load static %}
{% block title %}My Files{% endblock %}
{% block styling %}<link href="{% static 'health_tracker/myfiles.css' %}" rel="stylesheet">{% endblock %}

{% block body %}
   <div id="files_container">
      {% for file in files %}
         <div class="file_card">
            {% csrf_token %}
            <div class="inside_file_card"><a style="text-decoration: none;" href="media/{{file.file}}">
            <!-- <a href="{#% url 'file_page' file.recipent file.file %#}">kk</a> -->
               <div>
                  <img width="100%" class="img_class" id="img{{file.id}}" data-image="{{file.file}}">
               </div>
               <h5 class="file_name_class" id="file{{file.id}}" data-name={{file.file}}>{{file.file}}</h5>
               <!-- <a href="media/{{file.file}}"><h1 class="file_name_class" id="file{{file.id}}" data-name={{file.file}}>{{file.file}}</h1></a> -->
               <h6>Uploaded By: {{file.uploader.full_com_name}}</h6>
               <h6>Uploaded By: {{file.date}}</h6>
            </a></div>
            <!-- <h1>{{file.tags|slice:"2:"}}</h1> -->
         </div>
      {% endfor %}
   </div>
{% endblock %}
{% block script %}
   <script>
      // document.addEventListener('DOMContentLoaded',FilePathToString);
      let file_name_class = document.querySelectorAll('.file_name_class')
      let file_name_array=[...file_name_class]
      file_name_array.forEach(element => {
         FilePathToString(element.id.slice(4),element.getAttribute("data-name"))
      })
      function FilePathToString(id,file) {
         let path_name=String(`${file}`)
         let file_name=path_name.split("/").slice(-1)[0]
         document.querySelector(`#file${id}`).innerHTML=`${file_name}`;
      }
      
   </script>
   <script>
      let img_class=document.querySelectorAll('.img_class')
      let img_class_array=[...img_class]
      img_class_array.forEach(element => {
         main(element.id.slice(3),element.getAttribute("data-image"))
      })

      function handleBlob(blobResponse,id)
      {
         const imageObjectURL = URL.createObjectURL(blobResponse)
         // $("a").attr("href", imageObjectURL)
         // const code = `<img src="${imageObjectURL}">`
         // $('#files').prepend(code)
         document.querySelector(`#img${id}`).src=`${imageObjectURL}`
      }

      function main(id,file_path)
      {
         let token = $("input[name='csrfmiddlewaretoken']").val()
         // let url = "/get_file/{{ wbid }}/{{ name }}"
         let url = `/get_file/${file_path}`
         let header = {'X-CSRFToken': token}
         let request = fetch(url, {method: "POST", headers: header})
         // request.then(resp => resp.blob()).then(handleBlob)
         request.then(resp => resp.blob())
         .then((blobResponse) => {this.handleBlob(blobResponse,`${id}`)} )
      }
      $(document).ready(main)
   </script>
{% endblock %}